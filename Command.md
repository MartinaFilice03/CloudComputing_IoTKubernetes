# =====================================================
# IOT SYSTEM ON KUBERNETES - DEMO GUIDE
# =====================================================

# -----------------------------------------------------
# 1. START CLUSTER
# -----------------------------------------------------

minikube start
kubectl get nodes

# Set default namespace
kubectl config set-context --current --namespace=iot-project


# -----------------------------------------------------
# 2. BUILD DOCKER IMAGES (INSIDE MINIKUBE)
# -----------------------------------------------------

eval $(minikube docker-env)

# Build Reader
cd reader
docker build -t reader:1.0 .

# Build Writer
cd ../writer
docker build -t writer:1.0 .

cd ..


# -----------------------------------------------------
# 3. DEPLOY THE SYSTEM
# -----------------------------------------------------

cd k8s

kubectl apply -f postgres.yaml
kubectl apply -f writer.yaml
kubectl apply -f reader-deployment.yaml

kubectl get pods
kubectl get svc


# -----------------------------------------------------
# 4. VERIFY SYSTEM IS RUNNING
# -----------------------------------------------------

# Check all components are running
kubectl get pods
kubectl get svc

# Expected:
# postgres-0 → Running
# reader → Running
# writer → Running


# -----------------------------------------------------
# 5. ACCESS THE IOT SYSTEM (BROWSER DEMO)
# -----------------------------------------------------

# Forward local port to Kubernetes service
kubectl port-forward service/reader-service 5000:5000

# Open browser and show:
# http://localhost:5000
# http://localhost:5000/temperatures

# Expected result:
# JSON list of temperature values generated by Writer


# =====================================================
# NON-FUNCTIONAL ASPECTS DEMONSTRATION
# =====================================================


# -----------------------------------------------------
# 6. SELF-HEALING
# -----------------------------------------------------

kubectl get pods
kubectl delete pod <reader-pod-name>
kubectl get pods

# Kubernetes recreates the pod automatically


# -----------------------------------------------------
# 7. HIGH AVAILABILITY (SCALING READER)
# -----------------------------------------------------

kubectl scale deployment reader --replicas=3
kubectl get pods

# Multiple replicas running


# -----------------------------------------------------
# 8. HORIZONTAL SCALING (IOT LOAD SIMULATION)
# -----------------------------------------------------

kubectl scale deployment writer-deployment --replicas=5
kubectl get pods

# Multiple writers generating load


# -----------------------------------------------------
# 9. DATABASE FAULT TOLERANCE
# -----------------------------------------------------

kubectl delete pod postgres-0

# Wait for recreation
kubectl get pods

# Verify data persistence
kubectl exec -it postgres-0 -- psql -U postgres -d iot
SELECT COUNT(*) FROM temperatures;


# -----------------------------------------------------
# 10. DEBUG COMMANDS
# -----------------------------------------------------

kubectl get pods
kubectl get svc
kubectl get endpoints

kubectl logs -f deployment/writer-deployment
kubectl logs -f deployment/reader

kubectl describe pod <pod-name>


# -----------------------------------------------------
# 11. STOP CLUSTER
# -----------------------------------------------------

minikube stop

# To completely remove cluster:
# minikube delete